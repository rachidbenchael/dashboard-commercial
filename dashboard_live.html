<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dashboard Commercial Live</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body { font-family: Arial; background:#f4f6f9; padding:20px; }
h1 { text-align:center; }
.card { background:white; padding:20px; border-radius:10px; margin-bottom:30px; box-shadow:0 4px 10px rgba(0,0,0,0.1);}
table { width:100%; border-collapse:collapse; margin-top:10px;}
th, td { border:1px solid #ccc; padding:8px; text-align:center;}
th { background:#007bff; color:white;}
.green{color:green;font-weight:bold;}
.orange{color:orange;font-weight:bold;}
.red{color:red;font-weight:bold;}
</style>
</head>
<body>

<h1>ðŸ“Š Dashboard Commercial</h1>

<div class="card">
<h3>ðŸ“ˆ Taux dâ€™atteinte</h3>
<table id="tableCalcul"></table>
</div>

<div class="card">
<h3>ðŸŽ¯ Objectifs</h3>
<table id="tableObjectifs"></table>
</div>

<div class="card">
<h3>ðŸš€ RÃ©alisations</h3>
<table id="tableRealisations"></table>
</div>

<div class="card">
<h3>ðŸ“Š Graphique Total BiÃ¨res vs Total Vin (%)</h3>
<canvas id="chart"></canvas>
</div>

<script>

const sheetID = "1Vo4SDCb_udwvpx10lucyxWeiFiaDy-LhNjw0cB5cNOM";

function fetchSheet(sheetName, callback){
    const url = `https://docs.google.com/spreadsheets/d/${sheetID}/gviz/tq?tqx=out:json&sheet=${sheetName}`;
    fetch(url)
    .then(res => res.text())
    .then(data => {
        const json = JSON.parse(data.substr(47).slice(0,-2));
        const rows = json.table.rows.map(r => r.c.map(c => c ? c.v : ""));
        const headers = json.table.cols.map(col => col.label);
        callback(headers, rows);
    });
}

function fillTable(headers, rows, tableId, isPercent=false){
    const table = document.getElementById(tableId);
    table.innerHTML = "";
    
    let headerRow = "<tr>";
    headers.forEach(h => headerRow += `<th>${h}</th>`);
    headerRow += "</tr>";
    table.innerHTML += headerRow;

    rows.forEach(r => {
        let rowHTML = "<tr>";
        r.forEach(cell => {
            if(isPercent && typeof cell === "number"){
                let color = cell >= 100 ? "green" : (cell >= 80 ? "orange" : "red");
                rowHTML += `<td class="${color}">${cell}%</td>`;
            } else {
                rowHTML += `<td>${cell}</td>`;
            }
        });
        rowHTML += "</tr>";
        table.innerHTML += rowHTML;
    });
}

// Charger feuilles
fetchSheet("Calcul", (h,r)=>{
    fillTable(h,r,"tableCalcul",true);

    const labels = r.map(row=>row[1]);
    const totalB = r.map(row=>row[4]);
    const totalV = r.map(row=>row[7]);

    new Chart(document.getElementById("chart"),{
        type:"bar",
        data:{
            labels:labels,
            datasets:[
                {label:"Total BiÃ¨res %", data:totalB, backgroundColor:"rgba(54,162,235,0.7)"},
                {label:"Total Vin %", data:totalV, backgroundColor:"rgba(255,99,132,0.7)"}
            ]
        },
        options:{responsive:true}
    });
});

fetchSheet("Objectifs", (h,r)=> fillTable(h,r,"tableObjectifs"));
fetchSheet("RÃ©alisations", (h,r)=> fillTable(h,r,"tableRealisations"));

</script>
</body>
</html>
