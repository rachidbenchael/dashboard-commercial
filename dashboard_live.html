<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dashboard Commercial Live</title>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body { 
    font-family: Arial, sans-serif; 
    background:#f4f6f9; 
    padding:20px; 
}
h1 { 
    text-align:center; 
    margin-bottom:30px; 
    color:#333;
}
.card { 
    background:white; 
    padding:20px; 
    border-radius:10px; 
    margin-bottom:30px; 
    box-shadow:0 4px 10px rgba(0,0,0,0.1);
}
table { 
    width:100%; 
    border-collapse:collapse; 
    margin-top:10px;
}
th, td { 
    border:1px solid #ccc; 
    padding:8px; 
    text-align:center;
}
th { 
    background:#007bff; 
    color:white;
}
.green{color:green;font-weight:bold;}
.orange{color:orange;font-weight:bold;}
.red{color:red;font-weight:bold;}
</style>
</head>
<body>

<h1>ðŸ“Š Dashboard Commercial</h1>

<div class="card">
<h3>ðŸ“ˆ Taux dâ€™atteinte (Calcul)</h3>
<table id="tableCalcul"></table>
</div>

<div class="card">
<h3>ðŸŽ¯ Objectifs</h3>
<table id="tableObjectifs"></table>
</div>

<div class="card">
<h3>ðŸš€ RÃ©alisations</h3>
<table id="tableRealisations"></table>
</div>

<div class="card">
<h3>ðŸ“Š Graphique Total BiÃ¨res vs Total Vin (%)</h3>
<canvas id="chart"></canvas>
</div>

<script>
// ID de ton Google Sheet
const sheetID = "1Vo4SDCb_udwvpx10lucyxWeiFiaDy-LhNjw0cB5cNOM";

// Fonction pour lire une feuille
function fetchSheet(sheetName, callback){
    const url = `https://docs.google.com/spreadsheets/d/${sheetID}/gviz/tq?tqx=out:json&sheet=${sheetName}`;
    fetch(url)
    .then(res => res.text())
    .then(data => {
        // Transformer la rÃ©ponse google.visualization en JSON
        const json = JSON.parse(data.substring(data.indexOf("{"), data.lastIndexOf("}")+1));
        const rows = json.table.rows.map(r => r.c.map(c => c ? c.v : ""));
        const headers = json.table.cols.map(col => col.label);
        callback(headers, rows);
    })
    .catch(err => console.error("Erreur CSV :", err));
}

// Fonction pour remplir un tableau HTML
function fillTable(headers, rows, tableId, isPercent=false){
    const table = document.getElementById(tableId);
    table.innerHTML = "";

    let headerRow = "<tr>";
    headers.forEach(h => headerRow += `<th>${h}</th>`);
    headerRow += "</tr>";
    table.innerHTML += headerRow;

    rows.forEach(r => {
        let rowHTML = "<tr>";
        r.forEach(cell => {
            if(isPercent && typeof cell === "number"){
                let color = cell >= 1 ? "green" : (cell >= 0.8 ? "orange" : "red");
                rowHTML += `<td class="${color}">${(cell*100).toFixed(2)}%</td>`;
            } else {
                rowHTML += `<td>${cell}</td>`;
            }
        });
        rowHTML += "</tr>";
        table.innerHTML += rowHTML;
    });
}

// Charger les feuilles
fetchSheet("Calcul", (h,r)=>{
    fillTable(h,r,"tableCalcul",true);

    // PrÃ©parer le graphique
    const labels = r.map(row=>row[1]); // Commerciale
    const totalB = r.map(row=>row[4]*100); // Total BiÃ¨res %
    const totalV = r.map(row=>row[8]*100); // Total Vin %

    new Chart(document.getElementById("chart"),{
        type:"bar",
        data:{
            labels:labels,
            datasets:[
                {label:"Total BiÃ¨res %", data:totalB, backgroundColor:"rgba(54,162,235,0.7)"},
                {label:"Total Vin %", data:totalV, backgroundColor:"rgba(255,99,132,0.7)"}
            ]
        },
        options:{
            responsive:true,
            plugins:{
                legend:{position:"top"}
            },
            scales:{
                y:{
                    beginAtZero:true,
                    max:Math.max(...totalB.concat(totalV))*1.2
                }
            }
        }
    });
});

fetchSheet("Objectifs", (h,r)=> fillTable(h,r,"tableObjectifs"));
fetchSheet("RÃ©alisations", (h,r)=> fillTable(h,r,"tableRealisations"));

</script>

</body>
</html>
